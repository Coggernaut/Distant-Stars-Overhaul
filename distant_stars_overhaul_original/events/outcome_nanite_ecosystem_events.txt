namespace = distar_nanite_ecosystem
namespace = graygoo
namespace = harvest_nanite_gaia
namespace = nanite_ecosystem

##########################################
# L-Tiyanki Gas Giant Discoverable Event #
##########################################
ship_event = {
	id = nanite_ecosystem.1
	title = "nanite_ecosystem.1.name"
	desc = "nanite_ecosystem.1.desc"
	picture = GFX_evt_microscopic_life
	show_sound = event_ship_bridge
	location = from
	is_triggered_only = yes
	trigger = {
		from = { has_star_flag = nanite_ecosystem_elder_tiyanki_system }
	}
	option = { name = FASCINATING }
}

#########################################
# L-Amoeba Gas Giant Discoverable Event #
#########################################
ship_event = {
	id = nanite_ecosystem.2
	title = "nanite_ecosystem.2.name"
	desc = "nanite_ecosystem.2.desc"
	picture = GFX_evt_microscopic_life
	show_sound = event_ship_bridge
	location = from
	is_triggered_only = yes
	trigger = {
		from = { has_star_flag = nanite_ecosystem_elder_amoeba_system }
	}
	option = { name = FASCINATING }
}

#######################
# L-Nanite Incarnation#
#######################
### Event Triggers Upon On_Action Harvesting
country_event = {
	id = harvest_nanite_gaia.1
	title = "harvest_nanite_gaia.1.name"
	desc = "harvest_nanite_gaia.1.desc"
	picture = GFX_evt_gray_gooed_planet
	location = from
	hide_window = no
	is_triggered_only = yes
	option = {
		name = harvest_nanite_gaia.1.a
		ai_chance = {
			factor = 25
			modifier = { factor = 0 has_country_flag = avoid_harvesting_nanite_gaia_worlds }
		}
		root = {
			hidden_effect = {
				country_event = { id = harvest_nanite_gaia.2 days = 120 }
			}
		}
	}
	option = {
		name = harvest_nanite_gaia.1.b
		ai_chance = { factor = 75 }
		from = {
			change_pc = pc_nanite_gaia
			clear_deposits = yes
		}
		root = { set_country_flag = avoid_harvesting_nanite_gaia_worlds }
	}
}

### Final Warning
country_event = {
	id = harvest_nanite_gaia.2
	title = "harvest_nanite_gaia.2.name"
	desc = "harvest_nanite_gaia.2.desc"
	picture = GFX_evt_gray_goo
	location = fromfrom
	hide_window = no
	is_triggered_only = yes
	# Suggests Blowing it Up
	option = {
		name = harvest_nanite_gaia.2.a
		trigger = {
			any_owned_fleet = { is_ship_size = colossus }
		}
		hidden_effect = {
			country_event = { id = harvest_nanite_gaia.3 days = 90 }
		}
		enable_special_project = {
			name = "NEUTRALIZE_HARVEST_WORLD" # TODO
			location = fromfrom
			owner = root
		}
	}
	# Prepare for doom
	option = {
		name = harvest_nanite_gaia.2.b
		trigger = {
			NOT = { any_owned_fleet = { is_ship_size = colossus } }
		}
		hidden_effect = {
			country_event = { id = harvest_nanite_gaia.3 days = 90 }
		}
		enable_special_project = {
			name = "NEUTRALIZE_HARVEST_WORLD" # TODO
			location = fromfrom
			owner = root
		}
	}
}

# Establish Scope for Planet Event
country_event = {
	id = harvest_nanite_gaia.3
	title = "L_Gaia_Incarnation"
	desc = "harvest_nanite_gaia.3.desc"
	picture = GFX_evt_voidspawn
	location = fromfromfrom
	hide_window = no
	is_triggered_only = yes
	option = {
		name = harvest_nanite_gaia.3.a
		hidden_effect = {
			fromfromfrom = {
				planet_event = { id = harvest_nanite_gaia.31 }
			}
		}
	}
}

# TODO as window
# Spawns L-Gaia Incarnation & New Critter Faction
planet_event = {
	id = harvest_nanite_gaia.31
	# title = "harvest_nanite_gaia.31.name"
	# desc = "harvest_nanite_gaia.31.desc"
	# picture = GFX_evt_voidspawn
	# location = root
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_planet_class = pc_bh_harvest }
	# option = { name = harvest_nanite_gaia.31.a
	immediate = {
		change_pc = pc_egg_cracked
		hidden_effect = { clear_deposits = yes }
		remove_modifier = "terraforming_candidate"
		remove_modifier = "bh_harvest_modifier"
		hidden_effect = {
			space_owner = { set_country_flag = avoid_harvesting_nanite_gaia_worlds }
			if = {
				limit = {
					any_country = { is_country_type = lgaia_incarnation_country }
				}
				event_target:l_gaia_incarnation = {
					set_faction_hostility = {
						target = from
						set_hostile = yes
						set_neutral = no
						set_friendly = no
					}
				}
			} else = {
				create_country = {
					name = "L_Gaia_Incarnation"
					type = lgaia_incarnation_country
					effect = {
						set_name = "L_Gaia_Incarnation"
						save_global_event_target_as = l_gaia_incarnation
						every_playable_country = { establish_communications_no_message = prev }
						set_faction_hostility = {
							target = from
							set_hostile = yes
							set_neutral = no
							set_friendly = no
						}
					}
				}
			}
			root = {
				create_fleet = {
					name = "L_Gaia_Incarnation"
					settings = {
						is_boss = yes
						spawn_debris = no
						can_upgrade = no
						can_disband = yes
						can_change_composition = no
						can_change_leader = no
						uses_naval_capacity = no
					}
					effect = {
						set_owner = event_target:l_gaia_incarnation
						create_ship = {
							design = "NAME_Voidspawn"
							name = "L_Gaia_Incarnation"
							prefix = no
							upgradable = no
						}
						set_location = root
						set_fleet_stance = aggressive
						set_aggro_range_measure_from = self						# or return_point
						set_aggro_range = 300
						# auto_move_to_planet = {
						#	target = prev # dragon_point star
						#	clear_auto_move_on_arrival = yes # hang around
						# }
					}
				}
			}
		}
	}
}

#########################
# Entering Empty Cluster #
#########################
ship_event = {
	id = graygoo.550
	title = "graygoo.550.name"
	desc = "graygoo.550.desc"
	picture = GFX_evt_ruined_system
	show_sound = event_radio_chatter
	trackable = yes
	location = root.from
	is_triggered_only = yes
	trigger = {
		NOR = {
			has_global_flag = gray_goo_crisis_set
			# has_global_flag = dragon_season
			has_global_flag = gray_goo_empire_set
		}
		root.from = { has_star_flag = lcluster1 }
	}
	option = { name = graygoo.550.a }
}

#####################################
# Entering Nanite Ecosystem Cluster #
#####################################
# on_entering_system_first_time
ship_event = {
	id = nanite_ecosystem.550
	title = "nanite_ecosystem.550.name"
	desc = "nanite_ecosystem.550.desc"
	picture = GFX_evt_alien_nature
	show_sound = event_radio_chatter
	location = root.from
	is_triggered_only = yes
	trigger = {
		has_global_flag = ldragon_country_starts_nanite_ecosystem_flag
		root.from = { has_star_flag = lcluster1 }
	}
	option = { name = nanite_ecosystem.550.a }
}

####################
# Presapient Chain #
####################
ship_event = {
	id = nanite_ecosystem.6080
	title = "nanite_ecosystem.6080.name"
	desc = "nanite_ecosystem.6080.desc"
	picture = GFX_evt_microscopic_life
	location = root.from
	show_sound = event_default
	is_triggered_only = yes
	trigger = {
		root.from = { has_star_flag = nanite_ecosystem_presapient_system }
	}
	immediate = {
		owner = {
			set_country_flag = upl_ongoing_nanite_ecosystem_generic
			log = "upl_ongoing_nanite_ecosystem_generic_Flag set for nation"
			set_country_flag = found_presapients
			country_event = { id = tutorial.57 days = 5 }
			country_event = { id = story.4 days = 30 }
		}
	}
	option = {
		name = uplift.6000.a
		trigger = {
			owner = { has_technology = "tech_epigenetic_triggers" }
		}
	}
	option = {
		name = uplift.6000.b
		trigger = {
			owner = {
				NOT = { has_technology = "tech_epigenetic_triggers" }
			}
		}
	}
}

### Uplifting Generic Success
planet_event = {
	id = nanite_ecosystem.6081
	title = "uplift.6081.name"
	desc = "uplift.6081.desc"
	picture = GFX_evt_society_research
	location = root
	show_sound = notification_uplift
	is_triggered_only = yes
	trigger = {
		has_planet_flag = upl_ongoing_nanite_ecosystem_planet
		NOT = { has_planet_flag = snakeoid_planet }
	}
	immediate = {
		remove_planet_flag = upl_ongoing_nanite_ecosystem_planet
		owner = {
			set_country_flag = found_presapients
			remove_country_flag = upl_ongoing_nanite_ecosystem_generic
		}
	}
	option = {
		name = uplift.6011.a
		hidden_effect = {
			owner = {
				country_event = { id = tutorial.58 days = 5 }
			}
			planet_event = { id = uplift.7199 }
		}
	}
}

###############################
# L-Subterranean Colony Chain #
###############################

country_event = {
	id = nanite_ecosystem.10
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		# has_global_flag = ldragon_country_starts_nanite_ecosystem_flag
		has_global_flag = nanite_ecosystem_seismic_disturbance_global
		# OR = {
		# 	has_global_flag = l_cluster_opened
		# 	exists = event_target:lcluster1
		# }
	}
	immediate = {
		if = { limit = { has_global_flag = nanite_ecosystem_decade }
			remove_global_flag = nanite_ecosystem_decade
			every_playable_country = {
				limit = {
					OR = {
						has_country_flag = encountered_first_lgate
						has_country_flag = ldragon_known
						has_technology = tech_lgate_activation
						has_technology = tech_nanite_technology_mastery
					}
				}
				random_owned_planet = {
					limit = {
						has_owner = yes
						is_homeworld = no
						original_owner = yes
						has_ground_combat = no
						num_pops > 0
						 # solar_system = { has_star_flag = lcluster }
						has_planet_flag = nanite_ecosystem_seismic_disturbance
						OR = {
							has_planet_flag = nanite_ecosystem_seismic_disturbance_war
							has_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
							has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
						}
					}
					switch = { trigger = has_planet_flag
						nanite_ecosystem_seismic_disturbance_war = {
							random_list = {
								1 = { planet_event = { id = nanite_ecosystem.60 } modifier = { factor = 0.1 has_planet_flag = nanite_ecosystem_subterranean_invasion_planet } }
								1 = { planet_event = { id = nanite_ecosystem.61 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_collapse } }
								1 = { planet_event = { id = nanite_ecosystem.62 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_raid } }
								1 = { planet_event = { id = nanite_ecosystem.63 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_attack } }
							}
						}
						nanite_ecosystem_seismic_disturbance_destroyed = {
							random_list = {
								1 = { planet_event = { id = nanite_ecosystem.64 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_pocket } }
								1 = { planet_event = { id = nanite_ecosystem.65 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_expansion } }
								1 = { planet_event = { id = nanite_ecosystem.66 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_gold } }
								1 = { planet_event = { id = nanite_ecosystem.67 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_treasury } }
								1 = { planet_event = { id = nanite_ecosystem.68 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_quake } }
							}
						}
						nanite_ecosystem_seismic_disturbance_friendly = {
							random_list = {
								1 = { planet_event = { id = nanite_ecosystem.69 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_famine } }
								1 = { planet_event = { id = nanite_ecosystem.70 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_gift } }
								1 = { planet_event = { id = nanite_ecosystem.71 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_refugees } }
								1 = { planet_event = { id = nanite_ecosystem.72 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_anthropologists } }
								1 = { planet_event = { id = nanite_ecosystem.73 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_quake2 } }
								1 = { planet_event = { id = nanite_ecosystem.74 } modifier = { factor = 0 has_planet_flag = nanite_ecosystem_seismic_disturbance_tech } }
							}
						}
					}
				}
			}
		} else = { set_global_flag = nanite_ecosystem_decade }
	}
}

### Seismic Disturbances
planet_event = {
	id = nanite_ecosystem.50
	title = "colony.50.name"
	desc = "nanite_ecosystem.50.desc"
	picture = GFX_evt_in_the_dark
	show_sound = event_air_raid_siren
	location = root
	trackable = yes
	is_triggered_only = yes
	fire_only_once = yes
	pre_triggers = {
		original_owner = yes
		is_capital = no
		has_ground_combat = no
		is_homeworld = no
		is_occupied_flag = no
		has_owner = yes
	}
	trigger = {
		num_pops > 0
		NOR = {
			has_global_flag = nanite_ecosystem_seismic_disturbance_global
			has_planet_flag = colony_event
			is_planet_class = pc_nuked
			is_artificial = yes
			is_planet_class = pc_city
			is_planet_class = pc_relic
		}
		has_planet_flag = nanite_ecosystem_subterranean_planet # from distar_nanite_ecosystem.4
	}
	immediate = {
		owner = { save_event_target_as = nanite_ecosystem_subterranean_planet_owner }
		set_global_flag = nanite_ecosystem_seismic_disturbance_global
		set_planet_flag = nanite_ecosystem_seismic_disturbance
		set_planet_flag = colony_event
		add_deposit = d_underground_farm_blocked
		add_deposit = d_underground_mine_blocked
		add_deposit = d_underground_generator_blocked
	}
	option = {
		name = nanite_ecosystem.50.a
		begin_event_chain = {
			event_chain = "nanite_ecosystem_subterranean_civilization_chain"
			target = root
		}
		enable_special_project = {
			name = "NANITE_ECOSYSTEM_SEISMIC_DISTURBANCE_1_PROJECT"			# Establish Communications
			location = this
			owner = root
		}
		enable_special_project = {
			name = "NANITE_ECOSYSTEM_SEISMIC_DISTURBANCE_2_PROJECT"			# Preemptive Strike
			location = this
			owner = root
		}
	}
	option = {
		name = distar.216.a.exter
		exclusive_trigger = {
			owner = { is_homicidal = yes }
		}
		begin_event_chain = {
			event_chain = "nanite_ecosystem_subterranean_civilization_chain"
			target = root
		}
		enable_special_project = {
			name = "NANITE_ECOSYSTEM_SEISMIC_DISTURBANCE_2_PROJECT"			# Preemptive Strike
			location = this
			owner = root
		}
	}
}

# Special Project Completed 1
planet_event = {
	id = nanite_ecosystem.51
	title = "PROJECT_COMPLETE"
	desc = "nanite_ecosystem.51.desc"
	picture = GFX_evt_underground_civilization
	show_sound = event_alien_signal
	location = root
	is_triggered_only = yes
	immediate = {
		owner = { save_event_target_as = nanite_ecosystem_subterranean_planet_owner }
		set_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		create_species = {
			name = random
			class = random_non_machine
			portrait = random
			traits = random
			homeworld = root
			effect = { save_global_event_target_as = nanite_ecosystem_subterranean_species }
		}
		create_country = {
			name = "NAME_Nanite_Ecosystem_Subterranean_Nation"
			species = event_target:nanite_ecosystem_subterranean_species
			type = adversary
			ethos = random
			auto_delete = no
			flag = {
				icon = { category = "zoological" file = "flag_zoological_10.dds" }
				background = { category = "backgrounds" file = "new_dawn.dds" }
				colors = { "red" "black" "null" "null" }
			}
			effect = {
				set_name = "NAME_Nanite_Ecosystem_Subterranean_Nation"
				set_relation_flag = { who = root.owner flag = nanite_ecosystem_subterror }
				set_country_flag = nanite_ecosystem_subterranean_nation
				establish_contact = {
					who = event_target:nanite_ecosystem_subterranean_planet_owner
					location = root
				}
				establish_communications_no_message = event_target:nanite_ecosystem_subterranean_planet_owner
				save_global_event_target_as = nanite_ecosystem_subterranean_nation
			}
		}

	}
	option = {
		name = "colony.51.a"
		hidden_effect = {
			owner = {
				country_event = { id = nanite_ecosystem.53 }
			}
		}
	}
}

# Special Project Completed 2 or 3
planet_event = {
	id = nanite_ecosystem.52
	title = "PROJECT_COMPLETE"
	desc = "nanite_ecosystem.52.desc"
	picture = GFX_evt_underground_civilization
	show_sound = event_structural_collapse
	location = root
	is_triggered_only = yes
	immediate = {
		remove_planet_flag = nanite_ecosystem_seismic_disturbance_war
		set_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
		remove_deposit = d_underground_farm_blocked
		remove_deposit = d_underground_mine_blocked
		remove_deposit = d_underground_generator_blocked
		remove_deposit = d_underground_contact_zone
		add_deposit = d_underground_farm_dead
		add_deposit = d_underground_mine_dead
		add_deposit = d_underground_generator_dead
	}
	option = {
		name = nanite_ecosystem.52.a
		custom_tooltip = underground_expansion_tooltip
	}
}

# Subterranean Aliens
country_event = {
	id = nanite_ecosystem.53
	title = "nanite_ecosystem.53.name"
	desc = "nanite_ecosystem.53.desc"
	is_triggered_only = yes
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	option = {
		name = nanite_ecosystem.53.a
		response_text = nanite_ecosystem.53.a.response
		is_dialog_only = yes
	}
	option = {
		name = nanite_ecosystem.53.b
		response_text = nanite_ecosystem.53.b.response
		hidden_effect = {
			from = { set_planet_flag = nanite_ecosystem_seismic_disturbance_friendly }
		}
		from = {
			add_modifier = { modifier = "subterranean_civilization" days = -1 }
			add_deposit = d_underground_contact_zone
			# set_planet_flag = trade_size_increase
		}
		custom_tooltip = underground_expansion_tooltip
	}
	option = {
		name = nanite_ecosystem.53.c
		response_text = nanite_ecosystem.53.c.response
		hidden_effect = {
			from = {
				planet_event = { id = nanite_ecosystem.54 days = 35 random = 40 }
			}
		}
	}
}

# Subterranean Invasion!
planet_event = {
	id = nanite_ecosystem.54
	title = "nanite_ecosystem.54.name"
	desc = "nanite_ecosystem.54.desc"
	picture = GFX_evt_ground_combat
	show_sound = event_ground_battle
	location = root
	is_triggered_only = yes
	immediate = {
		owner = { set_country_flag = nanite_ecosystem_subterranean_invasion_country }
		set_planet_flag = nanite_ecosystem_subterranean_invasion_planet
		event_target:nanite_ecosystem_subterranean_nation = {
			create_leader = {
				class = general
				species = owner_main_species
				name = random
				skill = 3
			}
		}
		if = {
			limit = {
				event_target:nanite_ecosystem_subterranean_nation = { NOT = { has_country_flag = nanite_ecosystem_tech_request_approved } }
			}
			while = {
				count = 6
				create_army = {
					name = "NAME_Invading_Horde"
					owner = event_target:nanite_ecosystem_subterranean_nation
					species = event_target:nanite_ecosystem_subterranean_species
					type = "subterranean_industrial_army"
				}
			}
		}
		else_if = {
			limit = {
				event_target:nanite_ecosystem_subterranean_nation = { has_country_flag = nanite_ecosystem_tech_request_approved }
			}
			while = {
				count = 6
				create_army = {
					name = "NAME_Invading_Horde"
					owner = event_target:nanite_ecosystem_subterranean_nation
					species = event_target:nanite_ecosystem_subterranean_species
					type = "subterranean_postatomic_army"
				}
			}
		}
		last_created_army = {
			assign_leader = last_created_leader
		}
	}
	option = {
		name = "henrik.20.a"
		custom_tooltip = subterranean_invasion
	}
}

# Victory
country_event = {
	id = nanite_ecosystem.56
	title = "colony.56.name"
	desc = "nanite_ecosystem.56.desc"
	picture = GFX_evt_ground_combat
	show_sound = event_ground_battle
	location = fromfrom
	trackable = yes
	is_triggered_only = yes
	trigger = {
		has_country_flag = nanite_ecosystem_subterranean_invasion_country
		NOT = { has_country_flag = nanite_ecosystem_subterraneans_defeated_once }
		fromfrom = { has_planet_flag = nanite_ecosystem_subterranean_invasion_planet }
	}
	immediate = {
		remove_country_flag = nanite_ecosystem_subterranean_invasion_country
		set_country_flag = nanite_ecosystem_subterraneans_defeated_once
		fromfrom = {
			set_planet_flag = nanite_ecosystem_seismic_disturbance_war
			remove_planet_flag = nanite_ecosystem_subterranean_invasion_planet
		}
	}
	option = {
		name = "colony.56.a"
		enable_special_project = {
			name = "NANITE_ECOSYSTEM_SEISMIC_DISTURBANCE_3_PROJECT"			# Destroy them
			location = fromfrom
			owner = root
		}
	}
}

# Defeat
country_event = {
	id = nanite_ecosystem.57
	title = "colony.57.name"
	desc = "nanite_ecosystem.57.desc"
	picture = GFX_evt_burning_settlement
	show_sound = event_alien_signal
	location = fromfrom
	is_triggered_only = yes
	trigger = {
		has_country_flag = nanite_ecosystem_subterranean_invasion_country
		fromfrom = { has_planet_flag = nanite_ecosystem_subterranean_invasion_planet }
		from = { is_country_type = adversary }
	}
	immediate = {
		remove_country_flag = nanite_ecosystem_subterranean_invasion_country
		save_event_target_as = nanite_ecosystem_subterranean_former_planet_owner
		from = {
			save_event_target_as = nanite_ecosystem_subterranean_nation
			owner_species = { save_event_target_as = nanite_ecosystem_subterranean_species }
		}
		fromfrom = {
			create_country = {
				name = "NAME_Nanite_Ecosystem_Subterranean_Empire"
				species = event_target:nanite_ecosystem_subterranean_species
				type = default
				auto_delete = yes
				ethos = {
					ethic = ethic_fanatic_militarist
					ethic = ethic_authoritarian
				}
				authority = random
				civics = random
				flag = {
					icon = { category = "zoological" file = "flag_zoological_10.dds" }
					background = { category = "backgrounds" file = "new_dawn.dds" }
					colors = { "red" "black" "null" "null" }
				}
				effect = {
					set_name = "NAME_Nanite_Ecosystem_Subterranean_Empire"
					set_relation_flag = { who = event_target:nanite_ecosystem_subterranean_former_planet_owner flag = subwar }
					set_country_flag = nanite_ecosystem_subterranean_empire
					establish_communications_no_message = event_target:nanite_ecosystem_subterranean_former_planet_owner
					save_event_target_as = nanite_ecosystem_subterranean_empire
					owner_species = { save_event_target_as = nanite_ecosystem_subterranean_species }
				}
			}

		}
		from = { destroy_country = yes }
		fromfrom = {
			remove_planet_flag = nanite_ecosystem_subterranean_invasion_planet
			save_event_target_as = nanite_ecosystem_conquered_planet
			set_owner = event_target:nanite_ecosystem_subterranean_empire
			random_owned_pop = { kill_pop = yes }
			random_owned_pop = { kill_pop = yes }
			create_pop = { species = owner_main_species }
			create_pop = { species = owner_main_species }
			create_army = {
				name = "NAME_Loot-Equipped_Army"
				owner = event_target:nanite_ecosystem_subterranean_empire
				species = event_target:nanite_ecosystem_subterranean_species
				type = "defense_army"
			}
			create_army = {
				name = "NAME_Loot-Equipped_Army"
				owner = event_target:nanite_ecosystem_subterranean_empire
				species = event_target:nanite_ecosystem_subterranean_species
				type = "defense_army"
			}
			# flip starbase
			solar_system = {
				if = { limit = { exists = starbase }
					starbase = { set_owner = event_target:nanite_ecosystem_subterranean_empire }
				}
			}
		}
	}
	option = {
		name = "ONSCREEN"
		end_event_chain = "nanite_ecosystem_subterranean_civilization_chain"
		country_event = { id = nanite_ecosystem.58 }
	}
}

# Incoming Transmission
country_event = {
	id = nanite_ecosystem.58
	title = TRANSMISSION
	desc = "nanite_ecosystem.58.desc"
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:nanite_ecosystem_subterranean_empire
		planet_background = event_target:nanite_ecosystem_conquered_planet
		graphical_culture = event_target:nanite_ecosystem_conquered_planet
		room = event_target:nanite_ecosystem_subterranean_empire.ruler
	}
	option = { name = "colony.58.a" }
}

# Aliens Surface
planet_event = {
	id = nanite_ecosystem.59
	title = "nanite_ecosystem.59.name"
	desc = "nanite_ecosystem.59.desc"
	picture = GFX_evt_alien_cavemen
	show_sound = event_primitive_civilization
	location = root
	is_triggered_only = yes
	option = {
		name = nanite_ecosystem.59.a
		owner = {
			country_event = { id = nanite_ecosystem.53 }
		}
	}
}

# Another Invasion
planet_event = {
	id = nanite_ecosystem.60
	title = "nanite_ecosystem.54.name"
	desc = "nanite_ecosystem.60.desc"
	picture = GFX_evt_ground_combat
	show_sound = event_ground_battle
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_war
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		owner = { set_country_flag = nanite_ecosystem_subterranean_invasion_country }
		set_planet_flag = nanite_ecosystem_subterranean_invasion_planet
		random_country = {
			limit = {
				is_country_type = adversary
				has_country_flag = nanite_ecosystem_subterranean_nation
			}
			save_event_target_as = nanite_ecosystem_subterranean_nation
			owner_species = { save_event_target_as = nanite_ecosystem_subterranean_species }
			create_leader = {
				class = general
				species = event_target:nanite_ecosystem_subterranean_species
				name = random
				skill = 3
			}
		}
		if = {
			limit = {
				event_target:nanite_ecosystem_subterranean_nation = {
					NOT = { has_country_flag = nanite_ecosystem_tech_request_approved }
				}
			}
			while = {
				count = 8
				create_army = {
					name = "NAME_Invading_Horde"
					owner = event_target:nanite_ecosystem_subterranean_nation
					species = event_target:nanite_ecosystem_subterranean_species
					type = "industrial_army"
				}
			}
		}
		else_if = {
			limit = {
				event_target:nanite_ecosystem_subterranean_nation = { has_country_flag = nanite_ecosystem_tech_request_approved }
			}
			while = {
				count = 8
				create_army = {
					name = "NAME_Invading_Horde"
					owner = event_target:nanite_ecosystem_subterranean_nation
					species = event_target:nanite_ecosystem_subterranean_species
					type = "postatomic_army"
				}
			}
		}
		last_created_army = {
			assign_leader = last_created_leader
		}
	}
	option = {
		name = "colony.60.a"
		custom_tooltip = "subterranean_invasion"
	}
}

# Collapse
planet_event = {
	id = nanite_ecosystem.61
	title = "colony.61.name"
	desc = "nanite_ecosystem.61.desc"
	picture = GFX_evt_underground_civilization
	show_sound = event_structural_collapse
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_war
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_collapse }
		has_army = yes
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_collapse }
	option = {
		name = "colony.61.a"
		add_deposit = d_sinkhole_subterraneans
		random_planet_army = { remove_army = yes }
	}
}

# Raiding Parties
planet_event = {
	id = nanite_ecosystem.62
	title = "colony.62.name"
	desc = "nanite_ecosystem.62.desc"
	picture = GFX_evt_burning_settlement
	show_sound = event_ground_battle
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_war
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_raid }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		set_planet_flag = nanite_ecosystem_seismic_disturbance_raid
		add_planet_devastation = 10
	}
	option = {
		name = "colony.62.a"
		tooltip = { add_planet_devastation = 10 }
	}
}

# Surface Attack
planet_event = {
	id = nanite_ecosystem.63
	title = "colony.63.name"
	desc = "nanite_ecosystem.63.desc"
	picture = GFX_evt_burning_settlement
	show_sound = event_ground_battle
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_war
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_attack }
		num_pops > 1
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_attack }
	option = {
		name = "colony.63.a"
		add_planet_devastation = 10
		random_owned_pop = { kill_pop = yes }
		add_deposit = d_sinkhole_subterraneans
	}
}

# Survivor Pocket
planet_event = {
	id = nanite_ecosystem.64
	title = "colony.64.name"
	desc = "nanite_ecosystem.64.desc"
	picture = GFX_evt_in_the_dark
	show_sound = event_scanner
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_pocket }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		set_planet_flag = nanite_ecosystem_seismic_disturbance_pocket
		create_species = {
			name = random
			class = random_non_machine
			portrait = random
			traits = random
			homeworld = planet
			effect = { save_event_target_as = nanite_ecosystem_subterranean_species }
		}
	}
	option = { name = "colony.64.a" }
	option = {
		name = "colony.64.b"
		trigger = {
			# free_housing > 5
			owner = {
				OR = {
					is_authoritarian = yes
					is_xenophobe = yes
				}
			}
		}
		hidden_effect = {
			create_pop = {
				species = event_target:nanite_ecosystem_subterranean_species
				ethos = { ethic = "ethic_spiritualist" }
			}
			create_pop = {
				species = event_target:nanite_ecosystem_subterranean_species
				ethos = { ethic = "ethic_spiritualist" }
			}
			last_created_pop = {
				set_citizenship_type = {
					type = citizenship_slavery
					cooldown = yes
				}
			}
		}
	}
}

# Subterranean Expansion
planet_event = {
	id = nanite_ecosystem.65
	title = "nanite_ecosystem.65.name"
	desc = "nanite_ecosystem.65.desc"
	picture = GFX_evt_in_the_dark
	show_sound = event_construction
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_expansion }
		# has_any_strategic_resource = no
		num_pops > 0
		# planet_size < 25
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_expansion }
	option = {
		name = EXCELLENT
		add_modifier = { modifier = "subterranean_expansion" days = -1 }
		# change_planet_size = +1
	}
}

# Gold!
planet_event = {
	id = nanite_ecosystem.66
	title = "colony.66.name"
	desc = "nanite_ecosystem.66.desc"
	picture = GFX_evt_in_the_dark
	show_sound = event_mystic_reveal
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_gold }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		hidden_effect = { set_planet_flag = nanite_ecosystem_seismic_disturbance_gold }
	}
	option = {
		name = EXCELLENT
		owner = {
			add_monthly_resource_mult = {
				resource = energy
				value = @tier1materialreward
				min = @tier1materialmin
				max = @tier1materialmax
			}
		}
	}
}

# Treasury
planet_event = {
	id = nanite_ecosystem.67
	title = "colony.67.name"
	desc = "nanite_ecosystem.67.desc"
	picture = GFX_evt_in_the_dark
	show_sound = event_radio_chatter
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_treasury }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_treasury }
	option = {
		name = EXCELLENT
		owner = {
			add_monthly_resource_mult = {
				resource = energy
				value = @tier1materialreward
				min = @tier1materialmin
				max = @tier1materialmax
			}
		}
	}
}

# Earthquakes 1
planet_event = {
	id = nanite_ecosystem.68
	title = "colony.68.name"
	desc = "nanite_ecosystem.68.desc"
	picture = GFX_evt_burning_settlement
	show_sound = event_air_raid_siren
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_destroyed
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_quake }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		set_planet_flag = nanite_ecosystem_seismic_disturbance_quake
		add_planet_devastation = 10
	}
	option = {
		name = UNFORTUNATE
		tooltip = { add_planet_devastation = 10 }
	}
}

# Famine
planet_event = {
	id = nanite_ecosystem.69
	title = "colony.69.name"
	desc = "nanite_ecosystem.69.desc"
	picture = GFX_evt_alien_cavemen
	show_sound = event_primitive_civilization
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_famine }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_famine }
	option = {
		name = "colony.69.a"
		allow = {
			owner = {
				resource_stockpile_compare = { resource = food value >= 50 }
			}
		}
		owner = {
			add_resource = { food = -50 }
		}
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = -1 }
		}
		custom_tooltip = l_subterraneans_pleased
	}
	option = {
		name = "colony.69.b"
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = 1 }
		}
		custom_tooltip = l_subterraneans_displeased
	}
}

# Gift
planet_event = {
	id = nanite_ecosystem.70
	title = "colony.70.name"
	desc = "nanite_ecosystem.70.desc"
	picture = GFX_evt_alien_cavemen
	show_sound = event_primitive_civilization
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_gift }
		num_pops > 0
		check_variable = { which = "angry_subterraneans" value < 1 }
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_gift }
	option = {
		name = "colony.70.a"
		owner = {
			add_monthly_resource_mult = {
				resource = minerals
				value = @tier1materialreward
				min = @tier1materialmin
				max = @tier1materialmax
			}
		}
	}
}

# Subterranean Refugees
planet_event = {
	id = nanite_ecosystem.71
	title = "nanite_ecosystem.71.name"
	desc = "nanite_ecosystem.71.desc"
	picture = GFX_evt_alien_cavemen
	show_sound = event_primitive_civilization
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_refugees }
		num_pops > 0
		# free_housing > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		set_planet_flag = nanite_ecosystem_seismic_disturbance_refugees
		random_country = {
			limit = {
				is_country_type = adversary
				has_country_flag = nanite_ecosystem_subterranean_nation
			}
			owner_species = { save_event_target_as = nanite_ecosystem_subterranean_species }
		}
	}
	option = {
		name = "colony.71.a"
		trigger = {
			# free_housing > 0
		}
		create_pop = {
			species = event_target:nanite_ecosystem_subterranean_species
			ethos = { ethic = "ethic_spiritualist" }
		}
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = 1 }
		}
		custom_tooltip = l_subterraneans_displeased
	}
	option = {
		name = "colony.71.b"
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = -1 }
		}
		custom_tooltip = l_subterraneans_pleased
	}
}

# Xeno Anthropologists
planet_event = {
	id = nanite_ecosystem.72
	title = "colony.72.name"
	desc = "nanite_ecosystem.72.desc"
	picture = GFX_evt_underground_civilization
	show_sound = event_primitive_civilization
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_anthropologists }
		num_pops > 0
		check_variable = { which = "angry_subterraneans" value < 1 }
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_anthropologists }
	option = {
		name = EXCELLENT
		owner = {
			add_monthly_resource_mult = {
				resource = society_research
				value = @tier3researchreward
				min = @tier3researchmin
				max = @tier3researchmax
			}
		}
	}
}

# Earthquakes 2
planet_event = {
	id = nanite_ecosystem.73
	title = "colony.68.name"
	desc = "nanite_ecosystem.73.desc"
	picture = GFX_evt_underground_civilization
	show_sound = event_air_raid_siren
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_quake2 }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = {
		set_planet_flag = nanite_ecosystem_seismic_disturbance_quake2
		add_planet_devastation = 10
	}
	option = {
		name = "colony.73.a"
		tooltip = { add_planet_devastation = 10 }
		every_owned_pop = {
			add_modifier = { modifier = "pop_angry_subterranean" years = 10 }
		}
	}
	option = {
		name = "colony.73.b"
		tooltip = { add_planet_devastation = 10 }
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = 1 }
		}
		custom_tooltip = l_subterraneans_displeased
	}
}

# Request for Technology
planet_event = {
	id = nanite_ecosystem.74
	title = "colony.74.name"
	desc = "nanite_ecosystem.74.desc"
	picture = GFX_evt_alien_cavemen
	show_sound = event_primitive_civilization
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
		has_ground_combat = no
	}
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		NOT = { has_planet_flag = nanite_ecosystem_seismic_disturbance_tech }
		num_pops > 0
	}
	is_triggered_only = yes
	# mean_time_to_happen = { months = 240 }
	immediate = { set_planet_flag = nanite_ecosystem_seismic_disturbance_tech }
	option = {
		name = nanite_ecosystem.74.a
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = 1 }
		}
		custom_tooltip = l_subterraneans_displeased
	}
	option = {
		name = "colony.74.b"
		owner = {
			add_modifier = { modifier = subterranean_tech_transaction years = 10 }
		}
		hidden_effect = {
			change_variable = { which = "angry_subterraneans" value = -1 }
			random_country = {
				limit = {
					is_country_type = adversary
					has_country_flag = nanite_ecosystem_subterranean_nation
				}
				set_country_flag = nanite_ecosystem_tech_request_approved
			}
		}
		custom_tooltip = l_subterraneans_pleased
	}
}

# Message Delivered
planet_event = {
	id = nanite_ecosystem.75
	title = "colony.75.name"
	desc = "nanite_ecosystem.75.desc"
	picture = GFX_evt_alien_cavemen
	show_sound = event_primitive_civilization
	location = root
	pre_triggers = {
		has_owner = yes
		is_homeworld = no
		original_owner = yes
	}
	is_triggered_only = yes
	trigger = {
		has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
		check_variable = { which = "angry_subterraneans" value > 2 }
	}
	# mean_time_to_happen = { days = 20 }
	immediate = {
		hidden_effect = { remove_planet_flag = nanite_ecosystem_seismic_disturbance_friendly }
	}
	option = {
		name = "distar.29.a"
		owner = {
			country_event = { id = nanite_ecosystem.76 }
		}
	}
}

# Message
country_event = {
	id = nanite_ecosystem.76
	title = "colony.76.name"
	desc = "nanite_ecosystem.76.desc"
	is_triggered_only = yes
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	immediate = {
		random_country = {
			limit = {
				has_country_flag = nanite_ecosystem_subterranean_nation
				is_country_type = adversary
			}
			save_event_target_as = nanite_ecosystem_subterranean_nation
		}
	}
	option = {
		name = "colony.76.a"
		from = { remove_modifier = "subterranean_civilization" }
		hidden_effect = {
			from = {
				planet_event = { id = nanite_ecosystem.54 days = 35 random = 40 }
			}
		}
	}
}

# on_monthly_pulse
event = {
	id = nanite_ecosystem.77
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = nanite_ecosystem_seismic_disturbance_global
	}
	immediate = {
		every_playable_country = {
			limit = {
				any_owned_planet = {
					is_homeworld = no
					original_owner = yes
					has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
					check_variable = { which = "angry_subterraneans" value > 2 }
				}
			}
			random_owned_planet = {
				limit = {
					is_homeworld = no
					original_owner = yes
					has_planet_flag = nanite_ecosystem_seismic_disturbance_friendly
					check_variable = { which = "angry_subterraneans" value > 2 }
				}
				planet_event = { id = nanite_ecosystem.75 days = 5 random = 10 }
			}
		}
	}
}

############################################
# L-Cluster Ecosystem Generate Event Chain #
############################################

#######################
# L-Drake Event Spawn #
#######################
# on_entering_lgate
fleet_event = {
	id = distar_nanite_ecosystem.0
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		exists = owner
		NOT = { has_global_flag = ldragon_country_starts_nanite_ecosystem_flag }
		OR = {
			exists = event_target:spawning_dragons
			any_country = { is_country_type = ldragon_country }
		}
		# FROM = { has_star_flag = lcluster1 }
	}
	immediate = {
		owner = {
			country_event = { id = distar_nanite_ecosystem.1 }
			log = "L-Drake got event"
			if = { limit = { is_country_type = ldragon_country }
				log = "L-Drake has entered System"
			}
		}
		set_global_flag = ldragon_country_starts_nanite_ecosystem_flag
	}
}

### Setting System Flags for Events & Identification
country_event = {
	id = distar_nanite_ecosystem.1
	is_triggered_only = yes
	hide_window = yes
	fire_only_once = yes
	# trigger = {
	# 	NOT = { has_global_flag = distar_nanite_ecosystem_created_flag }
	# }
	immediate = {
		every_system = {
			limit = {
				has_star_flag = lcluster
				any_system_planet = { is_planet_class = pc_gray_goo }
			}
			every_system_planet = {
				limit = { is_planet_class = pc_gray_goo }
				# set_planet_flag = distar_nanite_ecosystem_planet_flag TODO unused?
				change_pc = pc_nanite_gaia
			}
		}
		# Randomly Establish Flags for Discoverable Events
		random_list = {
			11 = { random_system = { limit = { has_star_flag = lcluster1 } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster1_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster2 } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster2_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster3 } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster3_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster4 } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster4_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster5 } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster5_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster1b } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster1b_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster2b } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster2b_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster3b } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster3b_nanite_ecosystem_presapient_system" } }
			11 = { random_system = { limit = { has_star_flag = lcluster4b } set_star_flag = nanite_ecosystem_presapient_system log = "lcluster4b_nanite_ecosystem_presapient_system" } }
		}
		# set_global_flag = distar_nanite_ecosystem_created_flag
		country_event = { id = distar_nanite_ecosystem.2 }
	}
}

### Randomly Establish L-Tiyanki System
country_event = {
	id = distar_nanite_ecosystem.2
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		random_system = {
			limit = {
				has_star_flag = lcluster
				NOT = { has_star_flag = lcluster1 }
				count_system_planet = {
					limit = { is_planet_class = pc_nanite_gaia }
					count < 2
				}
				NOT = { has_star_flag = nanite_ecosystem_presapient_system }
			}
			every_system_planet = {
				limit = { is_star = yes }
				change_pc = pc_t_star
				create_ambient_object = {
					type = "space_storm_2"
					location = this
				}
				last_created_ambient_object = {
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
			}
			every_system_planet = {
				limit = { is_star = no }
				remove_planet = yes
			}
			set_star_flag = nanite_ecosystem_elder_tiyanki_system
		}
		country_event = { id = distar_nanite_ecosystem.3 }
	}
}

### Randomly Establish L-Amoeba System
country_event = {
	id = distar_nanite_ecosystem.3
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		random_system = {
			limit = {
				has_star_flag = lcluster
				NOT = { has_star_flag = lcluster1 }
				count_system_planet = {
					limit = { is_planet_class = pc_nanite_gaia }
					count < 2
				}
				NOR = {
					has_star_flag = nanite_ecosystem_presapient_system
					has_star_flag = nanite_ecosystem_elder_tiyanki_system
				}
			}
			every_system_planet = {
				limit = { is_star = yes }
				change_pc = pc_t_star
				create_ambient_object = {
					type = "space_storm_1"
					location = this
				}
				last_created_ambient_object = {
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
			}
			every_system_planet = {
				limit = { is_star = no }
				remove_planet = yes
			}
			set_star_flag = nanite_ecosystem_elder_amoeba_system
		}
		country_event = { id = distar_nanite_ecosystem.4 }
	}
}

### Populate Solar-Systems According to Events Flags
country_event = {
	id = distar_nanite_ecosystem.4
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		# set_global_flag = distar_nanite_ecosystem_populated_flag TODO unused?
		random_system = {
			limit = {
				has_star_flag = lcluster
				NOR = {
					has_star_flag = nanite_ecosystem_presapient_system
					has_star_flag = nanite_ecosystem_elder_tiyanki_system
					has_star_flag = nanite_ecosystem_elder_amoeba_system
				}
			}
			random_system_planet = {
				limit = { is_planet_class = pc_nanite_gaia }
				set_planet_flag = nanite_ecosystem_subterranean_planet
				log = "lcluster1_nanite_ecosystem_subterranean_planet"
			}
		}
		## L-Tiyanki
		random_system = {
			limit = { has_star_flag = nanite_ecosystem_elder_tiyanki_system }
			save_global_event_target_as = L_Tiyanki_HomeSystem
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Zathika Mev"
				orbit_distance = 55
				orbit_angle = 35
				size = 30
				has_ring = yes
				# flags = { tiyanki_l_gas_giant1 }
				init_effect = {
					set_name = "Zathika Mev"
					set_planet_flag = "tiyanki_l_gas_giant1"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_gas_giant1
					add_deposit = d_society_6
					add_modifier = { modifier = "l_tiyanki_spawn_modifier" days = -1 }
				}
			}
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Surribzha"
				orbit_distance = 65
				orbit_angle = 85
				size = 25
				has_ring = yes
				# flags = { tiyanki_l_gas_giant2 }
				init_effect = {
					set_name = "Surribzha"
					set_planet_flag = "tiyanki_l_gas_giant2"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_gas_giant2
					add_deposit = d_society_6
					add_modifier = { modifier = "l_tiyanki_spawn_modifier" days = -1 }
				}
			}
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Yllarv"
				orbit_distance = 85
				orbit_angle = 195
				size = 35
				has_ring = yes
				# flags = { tiyanki_l_gas_giant3 }
				init_effect = {
					set_name = "Yllarv"
					set_planet_flag = "tiyanki_l_gas_giant3"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_gas_giant3
					add_deposit = d_society_6
					add_modifier = { modifier = "l_tiyanki_spawn_modifier" days = -1 }
				}
			}
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Khetzhavu"
				orbit_distance = 45
				orbit_angle = 300
				size = 31
				has_ring = yes
				# flags = { tiyanki_l_gas_giant4 }
				init_effect = {
					set_name = "Khetzhavu"
					set_planet_flag = "tiyanki_l_gas_giant4"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_gas_giant4
					add_deposit = d_society_6
					add_modifier = { modifier = "l_tiyanki_spawn_modifier" days = -1 }
				}
			}
			random_system_planet = {
				limit = { is_planet_class = pc_nanite_gas_giant }
				# change_pc = pc_nanite_gas_giant
				clear_deposits = yes
				set_deposit = d_society_10
				add_deposit = d_exotic_gases_3
				set_planet_flag = l_tiyanki_elder_planet
				create_country = {
					name = "L-Tiyanki"
					type = l_tiyanki_elder_country
					flag = {
						icon = { category = "zoological" file = "flag_zoological_1.dds" }
						background = { category = "backgrounds" file = "00_solid.dds" }
						colors = {
							"black"
							"black"
							"null"
							"null"
						}
					}
					effect = {
						save_global_event_target_as = l_tiyanki_elder
						every_playable_country = { establish_communications_no_message = prev }
					}
				}
				create_fleet = {
					name = "L-Tiyanki Matriarch"
					settings = {
						is_boss = yes
						spawn_debris = no
						can_upgrade = no
						can_disband = yes
						can_change_composition = no
						can_change_leader = no
						uses_naval_capacity = no
					}
					effect = {
						set_owner = event_target:l_tiyanki_elder
						create_ship = {
							design = L_Progenitor
							name = "Matriarch"
							prefix = no
							upgradable = no
						}
						set_location = prev
						set_fleet_stance = aggressive
						set_aggro_range_measure_from = self						# or return_point
						set_aggro_range = 300
						# auto_move_to_planet = {
						#	target = prev # dragon_point star
						#	clear_auto_move_on_arrival = yes # hang around
						# }
					}
				}
			}
			create_l_tiyanki_home_fleet_1 = yes
			create_l_tiyanki_home_fleet_2 = yes
			create_l_tiyanki_home_fleet_3 = yes
			create_l_tiyanki_home_fleet_4 = yes
			create_l_tiyanki_home_roaming_fleets = yes
		}
		event_target:L_Tiyanki_HomeSystem = {
			while = {
				count = 3
				closest_system = {
					min_steps = 1
					max_steps = 3
					limit = {
						# has_any_lcluster_star_flag = yes
						NOR = {
							has_star_flag = l_tiyanki_territory_flag
							has_star_flag = nanite_ecosystem_elder_tiyanki_system
							has_star_flag = nanite_ecosystem_elder_amoeba_system
						}
					}
					set_star_flag = l_tiyanki_territory_flag
					random_system_planet = {
						random_list = {
							20 = { create_l_tiyanki_fleet_1 = yes }
							20 = { create_l_tiyanki_fleet_2 = yes }
							20 = { create_l_tiyanki_fleet_3 = yes }
							20 = { create_l_tiyanki_fleet_4 = yes }
							20 = { create_l_tiyanki_fleet_5 = yes }
						}
					}
				}
			}
		}
		## L-Amoeba
		random_system = {
			limit = { has_star_flag = nanite_ecosystem_elder_amoeba_system }
			save_global_event_target_as = L_Amoeba_HomeSystem
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Zathika Mev"
				orbit_distance = 55
				orbit_angle = 35
				size = 30
				has_ring = yes
				# flags = { l_amoeba_gas_giant1 }
				init_effect = {
					set_name = "Zathika Mev"
					set_planet_flag = "l_amoeba_gas_giant1"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_amoeba_gas_giant1
					add_deposit = d_society_6
					add_modifier = { modifier = "l_amoeba_spawn_modifier" days = -1 }
				}
			}
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Surribzha"
				orbit_distance = 65
				orbit_angle = 85
				size = 25
				has_ring = yes
				# flags = { l_amoeba_gas_giant2 }
				init_effect = {
					set_name = "Surribzha"
					set_planet_flag = "l_amoeba_gas_giant2"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_amoeba_gas_giant2
					add_deposit = d_society_6
					add_modifier = { modifier = "l_amoeba_spawn_modifier" days = -1 }
				}
			}
			spawn_planet = {
				class = pc_nanite_gas_giant
				name = "Veronax"
				orbit_distance = 85
				orbit_angle = 195
				size = 42
				has_ring = no
				# flags = { l_amoeba_gas_giant3 }
				init_effect = {
					set_name = "Veronax"
					set_planet_flag = "l_amoeba_gas_giant3"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_amoeba_gas_giant3
					add_deposit = d_exotic_gases_3
					add_deposit = d_society_6
					add_modifier = { modifier = "l_amoeba_spawn_modifier" days = -1 }
					# change_orbit = @base_moon_distance
					prev = {
						# moon = {
						spawn_planet = {
							class = pc_barren_cold
							location = event_target:l_amoeba_gas_giant3
							orbit_location = yes
							# orbit_angle = { min = 90 max = 270 }
							orbit_distance = 10
							orbit_distance_offset = 10
							orbit_angle_offset = 30
							size = 12
							init_effect = {
								prevent_anomaly = yes
								clear_deposits = yes
								add_deposit = d_minerals_4
								set_name = "NAME_Evor_Tomos"
							}
						}
						# moon = {
						spawn_planet = {
							class = pc_barren_cold
							location = event_target:l_amoeba_gas_giant3
							orbit_location = yes
							# orbit_angle = { min = 90 max = 270 }
							orbit_distance = 5
							orbit_distance_offset = 5
							orbit_angle_offset = 30
							size = 9
							init_effect = {
								prevent_anomaly = yes
								clear_deposits = yes
								add_deposit = d_society_6
								set_name = "NAME_Evor_Tomos"
							}
						}
					}
				}

			}
			spawn_planet = {
				class = "pc_nanite_gas_giant"
				name = "Khetzhavu"
				orbit_distance = 45
				orbit_angle = 300
				size = 31
				has_ring = yes
				# flags = { l_amoeba_gas_giant4 }
				init_effect = {
					set_name = "Khetzhavu"
					set_planet_flag = "l_amoeba_gas_giant4"
					prevent_anomaly = yes
					clear_deposits = yes
					save_global_event_target_as = l_amoeba_gas_giant4
					add_deposit = d_society_6
					add_modifier = { modifier = "l_amoeba_spawn_modifier" days = -1 }
				}
			}
			random_system_planet = {
				limit = { is_planet_class = pc_nanite_gas_giant }
				# change_pc = pc_nanite_gas_giant
				clear_deposits = yes
				set_deposit = d_society_10
				add_deposit = d_exotic_gases_3
				set_planet_flag = l_amoeba_elder_planet
				create_country = {
					name = "L-Amoeba"
					type = l_amoeba_elder_country
					flag = {
						icon = { category = "zoological" file = "flag_zoological_1.dds" }
						background = { category = "backgrounds" file = "00_solid.dds" }
						colors = { "black" "black" "null" "null" }
					}
					effect = {
						save_global_event_target_as = l_amoeba_elder
						every_playable_country = { establish_communications_no_message = prev }
					}
				}
				create_fleet = {
					name = "L-Amoeba Overlord"
					settings = {
						is_boss = yes
						spawn_debris = no
						can_upgrade = no
						can_disband = yes
						can_change_composition = no
						can_change_leader = no
						uses_naval_capacity = no
					}
					effect = {
						set_owner = event_target:l_amoeba_elder
						create_ship = {
							design = L_Great_Space_Organism
							name = "HUMAN1_SHIP_Overlord"
							prefix = no
							upgradable = no
						}
						set_location = prev
						set_fleet_stance = aggressive
						set_aggro_range_measure_from = self						# or return_point
						set_aggro_range = 300
						# auto_move_to_planet = {
						#	target = prev # dragon_point star
						#	clear_auto_move_on_arrival = yes # hang around
						# }
					}
				}
			}
			create_l_amoeba_home_fleet_1 = yes
			create_l_amoeba_home_fleet_2 = yes
			create_l_amoeba_home_fleet_3 = yes
			create_l_amoeba_home_fleet_4 = yes
			create_l_amoeba_home_roaming_fleets = yes
		}

		event_target:L_Amoeba_HomeSystem = {
			while = {
				count = 3
				closest_system = {
					min_steps = 1
					max_steps = 3
					limit = {
						# has_any_lcluster_star_flag = yes
						NOR = {
							has_star_flag = l_amoeba_territory_flag
							has_star_flag = nanite_ecosystem_elder_tiyanki_system
							has_star_flag = nanite_ecosystem_elder_amoeba_system
						}
					}
					set_star_flag = l_amoeba_territory_flag
					random_system_planet = {
						random_list = {
							20 = { create_l_amoeba_fleet_1 = yes }
							20 = { create_l_amoeba_fleet_2 = yes }
							20 = { create_l_amoeba_fleet_3 = yes }
							20 = { create_l_amoeba_fleet_4 = yes }
							20 = { create_l_amoeba_fleet_5 = yes }
						}
					}
				}
			}
		}
		event_target:l_amoeba_elder = {
			set_faction_hostility = {
				target = event_target:l_tiyanki_elder
				set_hostile = yes
				set_neutral = no
				set_friendly = no
			}
			prev = {
				set_faction_hostility = {
					target = prev
					set_hostile = yes
					set_neutral = no
					set_friendly = no
				}
			}
		}
		random_system = {
			limit = { has_star_flag = nanite_ecosystem_presapient_system }
			log = "Picking System for Pre Sapient"
			random_system_planet = {
				limit = { is_planet_class = pc_nanite_gaia }
				set_planet_flag = upl_ongoing_nanite_ecosystem_planet
				log = "Planet System for Pre Sapient"
				random_list = {
					15 = {
						create_species = {
							name = random
							class = "PRE_MAM"
							portrait = random
							traits = { trait = random_presapient_trait }
							homeworld = this
							sapient = no
						}
					}
					15 = {
						create_species = {
							name = random
							class = "PRE_REP"
							portrait = random
							traits = { trait = random_presapient_trait }
							homeworld = this
							sapient = no
						}
					}
					15 = {
						create_species = {
							name = random
							class = "PRE_AVI"
							portrait = random
							traits = { trait = random_presapient_trait }
							homeworld = this
							sapient = no
						}
					}
					15 = {
						create_species = {
							name = random
							class = "PRE_ART"
							portrait = random
							traits = { trait = random_presapient_trait }
							homeworld = this
							sapient = no
						}
					}
					15 = {
						create_species = {
							name = random
							class = "PRE_MOL"
							portrait = random
							traits = { trait = random_presapient_trait }
							homeworld = this
							sapient = no
						}
					}
					15 = {
						create_species = {
							name = random
							class = "PRE_FUN"
							portrait = random
							traits = { trait = random_presapient_trait }
							homeworld = this
							sapient = no
						}
					}
				}
				while = {
					limit = {
						count_owned_pop = {
							limit = { is_sapient = no }
							count < 3
						}
					}
					create_pop = { species = last_created_species }
				}
			}
		}
	}
}
